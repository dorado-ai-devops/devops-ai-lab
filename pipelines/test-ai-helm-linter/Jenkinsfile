pipeline {
  agent any

  environment {
    OPENAI_API_KEY = credentials('OPENAI_API_KEY')
  }

  parameters {
    choice(
      name: 'MODELO_IA',
      choices: ['openai', 'ollama'],
      description: 'Selecciona el motor de IA para linting de Helm Charts'
    )
  }

  stages {
    stage('Verificar Helm') {
      steps {
        sh 'helm version || (echo "Helm no estÃ¡ disponible en esta imagen." && exit 1)'
      }
    }

    stage('Empaquetar Helm Chart') {
      steps {
        script {
          def chartPath = "./charts/example"
          def chartDest = "packaged_chart"
          sh "mkdir -p ${chartDest}"
          def chartTgz = sh(script: "helm package ${chartPath} --destination ${chartDest} | awk '{print \$NF}'", returnStdout: true).trim()

          if (!fileExists(chartTgz)) {
            error "El archivo empaquetado ${chartTgz} no se ha generado correctamente."
          }

          env.CHART_FILE = chartTgz
        }
      }
    }

    stage('Lint con IA') {
      steps {
        script {
          def curlCommand = """
            curl -s -X POST http://helm-linter-service.devops-ai.svc.cluster.local:80/lint-chart \
              -F "chart=@${env.CHART_FILE}" \
              -F "mode=${params.MODELO_IA}"
          """

          if (params.MODELO_IA == 'openai') {
            curlCommand += " -H \"Authorization: Bearer ${OPENAI_API_KEY}\""
          }

          def response = sh(script: curlCommand, returnStdout: true).trim()
          echo "ðŸ“¡ Respuesta del Helm Linter IA (${params.MODELO_IA}):"
          echo response
        }
      }
    }
  }
}
